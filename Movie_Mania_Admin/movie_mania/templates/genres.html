{% extends "base.html" %}
{% block title %}Genres | Movie Mania{% endblock %}

{% block content %}
<div class="d-flex justify-content-between mb-3">
  <h3>Genres</h3>
  <button class="btn btn-danger" onclick="openAddGenre()">+ Add Genre</button>
</div>

<div class="card p-3 table-responsive">
  <table class="table table-dark table-hover align-middle">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="genresTable">
      <tr><td colspan="3" class="text-center">Loading...</td></tr>
    </tbody>
  </table>
</div>

<!-- ADD GENRE MODAL -->
<div class="modal fade" id="addGenreModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5>Add Genre</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addGenreForm">
          <input class="form-control mb-2" id="genre_name" placeholder="Genre Name">
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" onclick="addGenre()">Add</button>
      </div>
    </div>
  </div>
</div>

<!-- EDIT GENRE MODAL -->
<div class="modal fade" id="editGenreModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5>Edit Genre</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editGenreForm">
          <input type="hidden" id="edit_genre_id">
          <input class="form-control mb-2" id="edit_genre_name" placeholder="Genre Name">
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-warning" onclick="updateGenre()">Update</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js %}

<!-- jQuery CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
const API = "http://127.0.0.1:8000/api/admin/genres/";
const token = localStorage.getItem("adminToken");
const genresTable = document.getElementById("genresTable");

if (!token) location.href = "/";

// ================= LOAD GENRES =================
async function loadGenres() {
  try {
    const res = await fetch(API, {
      headers: { Authorization: "Bearer " + token }
    });

    const data = await res.json();

    genresTable.innerHTML = data.length
      ? data.map(g => `
        <tr>
          <td>${g.id}</td>
          <td>${g.name}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick='openEditGenre(${JSON.stringify(g)})'>‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="deleteGenre(${g.id})">üóë</button>
          </td>
        </tr>
      `).join("")
      : `<tr><td colspan="3" class="text-center">No genres found</td></tr>`;
  } catch (err) {
    genresTable.innerHTML =
      `<tr><td colspan="3" class="text-center text-danger">Failed to load genres</td></tr>`;
  }
}

// ================= OPEN ADD =================
function openAddGenre() {
  $("#addGenreForm")[0].reset();
  $(".text-danger").remove();
  new bootstrap.Modal(addGenreModal).show();
}

// ================= ADD GENRE =================
function addGenre() {

  $(".text-danger").remove();
  let valid = true;

  if ($("#genre_name").val().trim() === "") {
    $("#genre_name").after("<small class='text-danger'>Genre name is required</small>");
    valid = false;
  }

  if (!valid) return;

  const payload = { name: $("#genre_name").val().trim() };

  fetch(API, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify(payload)
  }).then(res => {
    if (!res.ok) {
      alert("Failed to add genre");
      return;
    }
    bootstrap.Modal.getInstance(addGenreModal).hide();
    loadGenres();
  });
}

// ================= OPEN EDIT =================
function openEditGenre(g) {
  $(".text-danger").remove();
  $("#edit_genre_id").val(g.id);
  $("#edit_genre_name").val(g.name);
  new bootstrap.Modal(editGenreModal).show();
}

// ================= UPDATE GENRE =================
function updateGenre() {

  $(".text-danger").remove();
  let valid = true;

  if ($("#edit_genre_name").val().trim() === "") {
    $("#edit_genre_name").after("<small class='text-danger'>Genre name is required</small>");
    valid = false;
  }

  if (!valid) return;

  const payload = { name: $("#edit_genre_name").val().trim() };

  fetch(API + $("#edit_genre_id").val() + "/", {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token
    },
    body: JSON.stringify(payload)
  }).then(res => {
    if (!res.ok) {
      alert("Failed to update genre");
      return;
    }
    bootstrap.Modal.getInstance(editGenreModal).hide();
    loadGenres();
  });
}

// ================= DELETE =================
async function deleteGenre(id) {
  if (!confirm("Delete this genre?")) return;

  const res = await fetch(API + id + "/", {
    method: "DELETE",
    headers: { Authorization: "Bearer " + token }
  });

  if (!res.ok) return alert("Failed to delete genre");

  loadGenres();
}

loadGenres();
</script>

{% endblock %}
