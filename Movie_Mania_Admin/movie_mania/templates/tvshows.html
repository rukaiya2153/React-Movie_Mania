{% extends "base.html" %}
{% block title %}TV Shows | Movie Mania{% endblock %}

{% block content %}
<div class="d-flex justify-content-between mb-3">
  <h3>TV Shows</h3>
  <button class="btn btn-danger" onclick="openAddShow()">+ Add TV Show</button>
</div>

<div class="card p-3 table-responsive">
  <table class="table table-dark table-hover align-middle">
    <thead>
      <tr>
        <th>Poster</th>
        <th>Title</th>
        <th>Genre</th>
        <th>Seasons</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="showsTable">
      <tr><td colspan="5" class="text-center">Loading...</td></tr>
    </tbody>
  </table>
</div>

<!-- ADD SHOW MODAL -->
<div class="modal fade" id="addShowModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5>Add TV Show</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="addShowForm">
          <input class="form-control mb-2" id="title" placeholder="Title">
          <textarea class="form-control mb-2" id="description" placeholder="Description"></textarea>
          <input class="form-control mb-2" id="total_seasons" type="number" placeholder="Total Seasons">
          <input class="form-control mb-2" id="thumbnail" type="file" accept="image/*">
          <input class="form-control mb-2" id="genre_id" type="number" placeholder="Genre ID">
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" id="addShowBtn">Add</button>
      </div>
    </div>
  </div>
</div>

<!-- EDIT SHOW MODAL -->
<div class="modal fade" id="editShowModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5>Edit TV Show</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editShowForm">
          <input type="hidden" id="edit_id">
          <input class="form-control mb-2" id="edit_title" placeholder="Title">
          <textarea class="form-control mb-2" id="edit_description" placeholder="Description"></textarea>
          <input class="form-control mb-2" id="edit_total_seasons" type="number" placeholder="Total Seasons">
          <input class="form-control mb-2" id="edit_thumbnail" type="file" accept="image/*">
          <input class="form-control mb-2" id="edit_genre_id" type="number" placeholder="Genre ID">
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-warning" id="updateShowBtn">Update</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block page_js %}
<!-- jQuery CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
const API = "http://127.0.0.1:8000/api/admin/shows/";
const token = localStorage.getItem("adminToken");
const showsTable = document.getElementById("showsTable");

if (!token) location.href = "/";

// ================= LOAD SHOWS =================
async function loadShows() {
  try {
    const res = await fetch(API, { headers: { Authorization: "Bearer " + token } });
    const data = await res.json();
    showsTable.innerHTML = data.length
      ? data.map(s => `
        <tr>
          <td><img src="${s.thumbnail}" width="50"></td>
          <td>${s.title}</td>
          <td>${s.genre}</td>
          <td>${s.total_seasons}</td>
          <td>
            <button class="btn btn-sm btn-warning" onclick='openEditShow(${JSON.stringify(s)})'>‚úèÔ∏è</button>
            <button class="btn btn-sm btn-danger" onclick="deleteShow(${s.id})">üóë</button>
          </td>
        </tr>
      `).join("")
      : `<tr><td colspan="5" class="text-center">No TV shows found</td></tr>`;
  } catch (err) {
    showsTable.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Failed to load shows</td></tr>`;
  }
}

// ================= OPEN ADD =================
function openAddShow() {
  $("#addShowForm")[0].reset();
  $(".text-danger").remove();
  new bootstrap.Modal(addShowModal).show();
}

// ================= ADD SHOW =================
$('#addShowBtn').on('click', async function(e) {
  e.preventDefault();
  $(".text-danger").remove();
  let valid = true;

  if ($('#title').val().trim() === "") {
    $('#title').after("<small class='text-danger'>Title is required</small>");
    valid = false;
  }
  if ($('#total_seasons').val().trim() === "") {
    $('#total_seasons').after("<small class='text-danger'>Total Seasons is required</small>");
    valid = false;
  }
  if ($('#genre_id').val().trim() === "") {
    $('#genre_id').after("<small class='text-danger'>Genre ID is required</small>");
    valid = false;
  }
  if ($('#thumbnail')[0].files.length === 0) {
    $('#thumbnail').after("<small class='text-danger'>Thumbnail is required</small>");
    valid = false;
  }

  if (!valid) return;

  const formData = new FormData();
  formData.append("title", $('#title').val().trim());
  formData.append("description", $('#description').val().trim());
  formData.append("total_seasons", $('#total_seasons').val().trim());
  formData.append("thumbnail", $('#thumbnail')[0].files[0]);
  formData.append("genre", $('#genre_id').val().trim());

  const res = await fetch(API, {
    method: "POST",
    headers: { Authorization: "Bearer " + token },
    body: formData
  });

  if (!res.ok) return alert("Failed to add show");

  bootstrap.Modal.getInstance(addShowModal).hide();
  $('#addShowForm')[0].reset();
  loadShows();
});

// ================= OPEN EDIT =================
function openEditShow(s) {
  $(".text-danger").remove();
  $('#edit_id').val(s.id);
  $('#edit_title').val(s.title);
  $('#edit_description').val(s.description);
  $('#edit_total_seasons').val(s.total_seasons);
  $('#edit_genre_id').val(s.genre);
  $('#edit_thumbnail').val("");
  new bootstrap.Modal(editShowModal).show();
}

// ================= UPDATE SHOW =================
$('#updateShowBtn').on('click', async function(e) {
  e.preventDefault();
  $(".text-danger").remove();
  let valid = true;

  if ($('#edit_title').val().trim() === "") {
    $('#edit_title').after("<small class='text-danger'>Title is required</small>");
    valid = false;
  }
  if ($('#edit_total_seasons').val().trim() === "") {
    $('#edit_total_seasons').after("<small class='text-danger'>Total Seasons is required</small>");
    valid = false;
  }
  if ($('#edit_genre_id').val().trim() === "") {
    $('#edit_genre_id').after("<small class='text-danger'>Genre ID is required</small>");
    valid = false;
  }

  if (!valid) return;

  const formData = new FormData();
  formData.append("title", $('#edit_title').val().trim());
  formData.append("description", $('#edit_description').val().trim());
  formData.append("total_seasons", $('#edit_total_seasons').val().trim());
  if ($('#edit_thumbnail')[0].files.length > 0) {
    formData.append("thumbnail", $('#edit_thumbnail')[0].files[0]);
  }
  formData.append("genre", $('#edit_genre_id').val().trim());

  const res = await fetch(API + $('#edit_id').val() + "/", {
    method: "PUT",
    headers: { Authorization: "Bearer " + token },
    body: formData
  });

  if (!res.ok) return alert("Failed to update show");

  bootstrap.Modal.getInstance(editShowModal).hide();
  loadShows();
});

// ================= DELETE SHOW =================
async function deleteShow(id) {
  if (!confirm("Delete this TV show?")) return;
  const res = await fetch(API + id + "/", {
    method: "DELETE",
    headers: { Authorization: "Bearer " + token }
  });
  if (!res.ok) return alert("Failed to delete show");
  loadShows();
}

loadShows();
</script>
{% endblock %}
