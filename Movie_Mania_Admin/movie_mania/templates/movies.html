{% extends "base.html" %}
{% block title %}Movies | Movie Mania{% endblock %}

{% block content %}

<div class="d-flex justify-content-between mb-3">
  <h3>Movies</h3>
  <button class="btn btn-danger" onclick="openAddMovie()">+ Add Movie</button>
</div>

<div class="card p-3 table-responsive">
  <table class="table table-dark table-hover align-middle">
    <thead>
      <tr>
        <th>Poster</th>
        <th>Title</th>
        <th>Genre</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="moviesTable">
      <tr>
        <td colspan="4" class="text-center">Loading...</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- ================= ADD MOVIE MODAL ================= -->
<div class="modal fade" id="addMovieModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white">

      <div class="modal-header">
        <h5>Add Movie</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="addMovieForm">
          <input class="form-control mb-2" id="title" placeholder="Title">
          <textarea class="form-control mb-2" id="description" placeholder="Description"></textarea>
          <input class="form-control mb-2" id="genre" type="number" placeholder="Genre ID">
          <input class="form-control mb-2" id="release_year" type="number" placeholder="Release Year">
          <input class="form-control mb-2" id="thumbnail" type="file">
          <input class="form-control mb-2" id="trailer" placeholder="Trailer URL">
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" onclick="submitMovie()">Add</button>
      </div>

    </div>
  </div>
</div>

<!-- ================= EDIT MOVIE MODAL ================= -->
<div class="modal fade" id="editMovieModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white">

      <div class="modal-header">
        <h5>Edit Movie</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="editMovieForm">
          <input type="hidden" id="edit_id">

          <input class="form-control mb-2" id="edit_title" placeholder="Title">
          <textarea class="form-control mb-2" id="edit_description" placeholder="Description"></textarea>
          <input class="form-control mb-2" id="edit_genre" type="number" placeholder="Genre ID">
          <input class="form-control mb-2" id="edit_release_year" type="number" placeholder="Release Year">
          <input class="form-control mb-2" id="edit_thumbnail" type="file">
          <input class="form-control mb-2" id="edit_trailer" placeholder="Trailer URL">
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-warning" onclick="updateMovie()">Update</button>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block page_js %}

<!-- jQuery CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
const API = "http://127.0.0.1:8000/api/admin/movies/";
const token = localStorage.getItem("adminToken");

if (!token) location.href = "/";

// ================= LOAD MOVIES =================
async function loadMovies() {
  const res = await fetch(API, {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();

  moviesTable.innerHTML = data.map(m => `
    <tr>
      <td>${m.thumbnail ? `<img src="${m.thumbnail}" width="50">` : "-"}</td>
      <td>${m.title}</td>
      <td>${m.genre_name || m.genre}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick='openEditMovie(${JSON.stringify(m)})'>‚úèÔ∏è</button>
        <button class="btn btn-sm btn-danger" onclick="deleteMovie(${m.id})">üóë</button>
      </td>
    </tr>
  `).join("");
}

// ================= ADD MOVIE =================
function openAddMovie() {
  $("#addMovieForm")[0].reset();
  $(".text-danger").remove();
  new bootstrap.Modal(addMovieModal).show();
}

function submitMovie() {

  $(".text-danger").remove();
  let valid = true;

  if ($("#title").val().trim() === "") {
    $("#title").after("<small class='text-danger'>Title is required</small>");
    valid = false;
  }

  if ($("#description").val().trim() === "") {
    $("#description").after("<small class='text-danger'>Description is required</small>");
    valid = false;
  }

  if ($("#genre").val().trim() === "") {
    $("#genre").after("<small class='text-danger'>Genre ID is required</small>");
    valid = false;
  }

  if ($("#release_year").val().trim() === "") {
    $("#release_year").after("<small class='text-danger'>Release year is required</small>");
    valid = false;
  }

  if ($("#thumbnail").val() === "") {
    $("#thumbnail").after("<small class='text-danger'>Thumbnail is required</small>");
    valid = false;
  }

  if (!valid) return;

  const fd = new FormData();
  fd.append("title", $("#title").val());
  fd.append("description", $("#description").val());
  fd.append("genre", $("#genre").val());
  fd.append("release_year", $("#release_year").val());
  fd.append("trailer_url", $("#trailer").val());

  if ($("#thumbnail")[0].files[0]) {
    fd.append("thumbnail", $("#thumbnail")[0].files[0]);
  }

  fetch(API, {
    method: "POST",
    headers: { Authorization: "Bearer " + token },
    body: fd
  }).then(() => {
    bootstrap.Modal.getInstance(addMovieModal).hide();
    loadMovies();
  });
}

// ================= EDIT MOVIE =================
function openEditMovie(m) {
  $(".text-danger").remove();

  $("#edit_id").val(m.id);
  $("#edit_title").val(m.title);
  $("#edit_description").val(m.description);
  $("#edit_genre").val(m.genre);
  $("#edit_release_year").val(m.release_year);
  $("#edit_trailer").val(m.trailer_url || "");

  new bootstrap.Modal(editMovieModal).show();
}

function updateMovie() {

  $(".text-danger").remove();
  let valid = true;

  if ($("#edit_title").val().trim() === "") {
    $("#edit_title").after("<small class='text-danger'>Title is required</small>");
    valid = false;
  }

  if ($("#edit_description").val().trim() === "") {
    $("#edit_description").after("<small class='text-danger'>Description is required</small>");
    valid = false;
  }

  if ($("#edit_genre").val().trim() === "") {
    $("#edit_genre").after("<small class='text-danger'>Genre ID is required</small>");
    valid = false;
  }

  if ($("#edit_release_year").val().trim() === "") {
    $("#edit_release_year").after("<small class='text-danger'>Release year is required</small>");
    valid = false;
  }

  if (!valid) return;

  const id = $("#edit_id").val();
  const fd = new FormData();

  fd.append("title", $("#edit_title").val());
  fd.append("description", $("#edit_description").val());
  fd.append("genre", $("#edit_genre").val());
  fd.append("release_year", $("#edit_release_year").val());
  fd.append("trailer_url", $("#edit_trailer").val());

  if ($("#edit_thumbnail")[0].files[0]) {
    fd.append("thumbnail", $("#edit_thumbnail")[0].files[0]);
  }

  fetch(API + id + "/", {
    method: "PUT",
    headers: { Authorization: "Bearer " + token },
    body: fd
  }).then(() => {
    bootstrap.Modal.getInstance(editMovieModal).hide();
    loadMovies();
  });
}

// ================= DELETE =================
async function deleteMovie(id) {
  if (!confirm("Delete this movie?")) return;
  await fetch(API + id + "/", {
    method: "DELETE",
    headers: { Authorization: "Bearer " + token }
  });
  loadMovies();
}

loadMovies();
</script>

{% endblock %}
