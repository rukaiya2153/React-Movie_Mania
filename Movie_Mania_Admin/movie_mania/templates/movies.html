{% extends "base.html" %}
{% block title %}Movies | Movie Mania{% endblock %}

{% block content %}

<div class="d-flex justify-content-between mb-3">
  <h3>Movies</h3>
  <button class="btn btn-danger" onclick="openAddMovie()">+ Add Movie</button>
</div>

<div class="card p-3 table-responsive">
  <table class="table table-dark table-hover align-middle">
    <thead>
      <tr>
        <th>Poster</th>
        <th>Title</th>
        <th>Genre</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="moviesTable">
      <tr>
        <td colspan="4" class="text-center">Loading...</td>
      </tr>
    </tbody>
  </table>
</div>

<!-- ================= ADD MOVIE MODAL ================= -->
<div class="modal fade" id="addMovieModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white">

      <div class="modal-header">
        <h5>Add Movie</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="addMovieForm">
          <input class="form-control mb-2" id="title" placeholder="Title">
          <textarea class="form-control mb-2" id="description" placeholder="Description"></textarea>
          <input class="form-control mb-2" id="genre" type="number" placeholder="Genre ID">
          <input class="form-control mb-2" id="release_year" type="number" placeholder="Release Year">
          <input class="form-control mb-2" id="thumbnail" type="file">
          <input class="form-control mb-2" id="trailer" placeholder="Trailer URL">
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" onclick="submitMovie()">Add</button>
      </div>

    </div>
  </div>
</div>

<!-- ================= EDIT MOVIE MODAL ================= -->
<div class="modal fade" id="editMovieModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark text-white">

      <div class="modal-header">
        <h5>Edit Movie</h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="editMovieForm">
          <input type="hidden" id="edit_id">

          <input class="form-control mb-2" id="edit_title">
          <textarea class="form-control mb-2" id="edit_description"></textarea>
          <input class="form-control mb-2" id="edit_genre" type="number">
          <input class="form-control mb-2" id="edit_release_year" type="number">
          <input class="form-control mb-2" id="edit_thumbnail" type="file">
          <input class="form-control mb-2" id="edit_trailer">
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-warning" onclick="updateMovie()">Update</button>
      </div>

    </div>
  </div>
</div>

{% endblock %}

{% block page_js %}
<script>
const API = "http://127.0.0.1:8000/api/admin/movies/";
const token = localStorage.getItem("adminToken");

if (!token) location.href = "/";

// LOAD MOVIES
async function loadMovies() {
  const res = await fetch(API, {
    headers: { Authorization: "Bearer " + token }
  });
  const data = await res.json();

  moviesTable.innerHTML = data.map(m => `
    <tr>
      <td>${m.thumbnail ? `<img src="${m.thumbnail}" width="50">` : "-"}</td>
      <td>${m.title}</td>
      <td>${m.genre_name || m.genre}</td>
      <td>
        <button class="btn btn-sm btn-warning" onclick='openEditMovie(${JSON.stringify(m)})'>‚úèÔ∏è</button>
        <button class="btn btn-sm btn-danger" onclick="deleteMovie(${m.id})">üóë</button>
      </td>
    </tr>
  `).join("");
}

// ADD
function openAddMovie() {
  new bootstrap.Modal(addMovieModal).show();
}

async function submitMovie() {
  const fd = new FormData();
  fd.append("title", title.value);
  fd.append("description", description.value);
  fd.append("genre", genre.value);
  fd.append("release_year", release_year.value);
  fd.append("trailer_url", trailer.value);
  if (thumbnail.files[0]) fd.append("thumbnail", thumbnail.files[0]);

  await fetch(API, {
    method: "POST",
    headers: { Authorization: "Bearer " + token },
    body: fd
  });

  bootstrap.Modal.getInstance(addMovieModal).hide();
  loadMovies();
}

// EDIT
function openEditMovie(m) {
  edit_id.value = m.id;
  edit_title.value = m.title;
  edit_description.value = m.description;
  edit_genre.value = m.genre;
  edit_release_year.value = m.release_year;
  edit_trailer.value = m.trailer_url || "";

  new bootstrap.Modal(editMovieModal).show();
}

async function updateMovie() {
  const id = edit_id.value;
  const fd = new FormData();

  fd.append("title", edit_title.value);
  fd.append("description", edit_description.value);
  fd.append("genre", edit_genre.value);
  fd.append("release_year", edit_release_year.value);
  fd.append("trailer_url", edit_trailer.value);

  if (edit_thumbnail.files[0]) {
    fd.append("thumbnail", edit_thumbnail.files[0]);
  }

  await fetch(API + id + "/", {
    method: "PUT",
    headers: { Authorization: "Bearer " + token },
    body: fd
  });

  bootstrap.Modal.getInstance(editMovieModal).hide();
  loadMovies();
}

// DELETE
async function deleteMovie(id) {
  if (!confirm("Delete this movie?")) return;
  await fetch(API + id + "/", {
    method: "DELETE",
    headers: { Authorization: "Bearer " + token }
  });
  loadMovies();
}

loadMovies();
</script>
{% endblock %}
